<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screenshot Taker Web Component</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* Custom styling for the web component */
        screenshot-taker {
            display: block;
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 12px; /* Custom rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .screenshot-button {
            background-color: #28a745; /* Bootstrap success green */
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px; /* Custom rounded corners */
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .screenshot-button:hover {
            background-color: #218838; /* Darker green on hover */
            transform: translateY(-2px);
        }

        .screenshot-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .loading-indicator {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
        }

        .preview-image {
            max-width: 100%;
            height: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px; /* Custom rounded corners */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <h1 class="text-center mb-4 text-dark">Web Component Screenshot Demo</h1>

    <div id="fulldiv" class="bg-info-subtle p-4 rounded-3 shadow-sm mb-4 w-100" style="max-width: 600px;">
        <p class="text-info-emphasis fs-5">
            This is some sample content on the page that will be captured by the screenshot component.
            You can add more elements, images, or text here to see how `html2canvas` renders them.
        </p>
        <img src="https://placehold.co/300x150/FF6347/FFFFFF?text=Sample+Image" alt="Placeholder Image" class="mt-3 rounded shadow-sm mx-auto d-block">
        <ul class="mt-3 text-info-emphasis">
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
            <li>Item 1</li>
            <li>Item 2</li>
            <li>Item 3</li>
        </ul>
    </div>
    <video id="video" autoplay muted playsinline></video>

    <!-- The custom web component -->
    <screenshot-taker></screenshot-taker>

    <!-- html2canvas library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Bootstrap JS (Popper.js and Bootstrap bundle) -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" xintegrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" xintegrity="sha384-0pUGZvbkm6XF6gxjEnlco4jJ8yuWwIH72ObQ5oB5FdcfghgjrGC2gxijgSSw" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<script>

class ScreenshotTaker extends HTMLElement {
    constructor() {
        super();
        // Create a shadow root for encapsulation
        this.innerHTML = `
            <button id="takeScreenshotBtn" type="button" class="nav-link" title="Take Screenshot"><i class="bi-camera"></i></button>
        `;
        const showimage = `
<div class="offcanvas offcanvas-start" data-bs-backdrop="static" tabindex="-1" aria-labelledby="staticBackdropLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="staticBackdropLabel">Screenshot Preview</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <img class="w-100" alt="Screenshot Preview">
    <p class="text-sm text-muted mt-2">Right-click or long-press the image to save it.</p>
  </div>
</div>
        `;
        this.takeScreenshotBtn = this.querySelector("button");
        this.section = document.createElement("section");
        //this.section.style.display = "none";
        this.section.insertAdjacentHTML("beforeend", showimage);
        document.body.appendChild(this.section);
        this.screenshotPreview = this.section.querySelector("img");
        this.previewContainer = new bootstrap.Offcanvas(this.section.querySelector(".offcanvas"));

        //this.takeScreenshotBtn.addEventListener('click', this.takeScreenshot.bind(this));
        this.takeScreenshotBtn.addEventListener('click', this.captureScreen.bind(this));
    }

    async takeScreenshot() {
        this.takeScreenshotBtn.classList.add = 'waiting';
        this.takeScreenshotBtn.disabled = true;
        this.screenshotPreview.src = ''; // Clear previous preview

        try {
            // Capture the entire body of the document
            //this.screenelement = document.querySelectorAll(this.getAttribute("target-element"))[0]; 
            this.screenelement = document.querySelectorAll("main article:not(.d-none)")[0];
            const bc = document.documentElement.dataset.bsTheme == "dark" ? "#212529" : "#ffffff";
            const canvas = await html2canvas(this.screenelement, {
                backgroundColor: bc, foreignObjectRendering: false,
                useCORS: true, // Important for handling images from different origins
                logging: true, // Enable logging for debugging
                ignoreElements: "script, template, ",
            });

            const imgData = canvas.toDataURL('image/png'); // Get image data as PNG

            // Display the preview
            this.screenshotPreview.src = imgData;
            //this.previewContainer.style.display = 'block';
            this.previewContainer.show();

            toastr["success"]('Screenshot captured successfully! Right-click the image to save.', 'success');

        } catch (error) {
            console.log('Error taking screenshot:', error);
            toastr["error"]('Failed to capture screenshot. Please try again.', 'error');
        } finally {
            this.takeScreenshotBtn.classList.remove = 'waiting';
            this.takeScreenshotBtn.disabled = false;
        }
    }
    /*
      areas.forEach((color) => {
        const button = document.getElementById(color + "Button");
        button.onclick = async () => {
          const target = document.getElementById(color + "Div");
          if (
            video.srcObject &&
            video.srcObject.getVideoTracks().length > 0 &&
            video.srcObject.getVideoTracks()[0].readyState == "live"
          ) {
            const restrictionTarget = await RestrictionTarget.fromElement(
              target
            );
            videoTrack = video.srcObject.getVideoTracks()[0];
            await videoTrack.restrictTo(restrictionTarget);
          } else {
            const stream = await navigator.mediaDevices.getDisplayMedia({
              preferCurrentTab: true,
            });
            const [videoTrack] = stream.getVideoTracks();
            const restrictionTarget = await RestrictionTarget.fromElement(
              target
            );
            await videoTrack.restrictTo(restrictionTarget);
            video.srcObject = stream;
          }
        };
      });
*/
    async captureScreen() {
        try {
            //const video = document.createElement('video');
            const video = document.getElementById("video");
            const target = document.getElementById("fulldiv");
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    preferCurrentTab: true,
                });
                const [videoTrack] = stream.getVideoTracks();
                const restrictionTarget = await RestrictionTarget.fromElement(
                    target
                );
                await videoTrack.restrictTo(restrictionTarget);
        
                video.srcObject = stream;

                //this.previewContainer.show();
            //this.screenelement = document.querySelectorAll("main article:not(.d-none)")[0];
/*            video.onloadedmetadata = () => {
                video.play();
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageURL = canvas.toDataURL('image/png');

                this.screenshotPreview.src = imageURL;
                this.previewContainer.show();

                toastr["success"]('Screenshot captured successfully! Right-click the image to save.', 'success');

                // const img = document.createElement('img');
                // img.src = imageURL;
                // document.body.appendChild(img);
                stream.getTracks().forEach(track => track.stop());
            };
 */       } catch (error) {
            console.error("Error capturing screen:", error);
        }
    }    
}
// remaining task to save to folder think and position
// Define the custom element
customElements.define('screenshot-taker', ScreenshotTaker);

</script>


</body>
</html>

